<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Windows下使用wsl2打造极致开发环境 · 潇晗宇浩的博客</title><meta name="description" content="自Windows Terminal发布后一直用得很爽, 我也一直在关注着另一个神器wsl2的到来. Windows 2004 RTM版出来后我便立即重装了系统, 感受到了wsl2的强大. 本文的主要内容就是如何配置wsl2并解决它带来的一些问题"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.xhyh.best/rss2.xml" title="潇晗宇浩的博客"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/rss2.xml" title="潇晗宇浩的博客" type="application/rss+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/categories/" target="_self">CATEGORY</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/achjqz" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/rss2.xml" target="_self">RSS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/friends/" target="_self">FRIENDS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Windows下使用wsl2打造极致开发环境</h1><div class="post-info">Apr 14, 2020<a class="tag-title" href="/tags/windows/">#windows</a><a class="tag-title" href="/tags/wsl2/">#wsl2</a></div><div class="post-content"><p>自Windows Terminal发布后一直用得很爽, 我也一直在关注着另一个'神器'wsl2的到来. Windows 2004 RTM版出来后我便立即重装了系统, 感受到了wsl2的强大. 本文的主要内容就是如何配置wsl2并解决它带来的一些问题</p>
<a id="more"></a>
<h4 id="为什么需要wsl2">为什么需要wsl2</h4>
<p>如果你是一个开发人员, 一定有以下几个痛点</p>
<ol type="1">
<li>安装软件麻烦, c++应该下哪个? python应该下哪个? vscode对应的配置怎么配?</li>
<li>残缺的<code>Git bash</code>, <code>wget</code> 命令去哪了? <code>md5sum</code>在哪?</li>
<li>巨慢的<code>git clone</code>, ssh怎么不走代理啊? 怎么配置?</li>
<li>乱码问题, 我使用<code>UTF-8</code>编码, 怎么运行到命令行就乱码?</li>
</ol>
<p><code>Windows</code>下还有很多问题就不一一列举了</p>
<h4 id="wsl2能解决的问题">wsl2能解决的问题</h4>
<ol type="1">
<li>真实<code>Linux</code>内核, 带来了完整的<code>Linux</code>体验</li>
<li>优化后的IO速度, 读写速度快</li>
<li>内存回收技术, 避免占用过多内存不释放</li>
<li>自动挂载Windows磁盘, 无缝访问Windows文件</li>
</ol>
<h4 id="wsl2安装">wsl2安装</h4>
<p>具体安装请看<a href="https://docs.microsoft.com/en-us/windows/wsl/wsl2-install" target="_blank" rel="noopener">官方文档</a></p>
<p>大致的步骤是</p>
<ol type="1">
<li>打开可选功能的<code>适用于Linux的Windows子系统</code>和<code>虚拟机平台</code></li>
<li>重启计算机</li>
<li>在<code>Windows Store</code>中下载<code>Linux</code>发行版, 如<code>Ubuntu</code></li>
<li>启动<code>Ubuntu</code>, 设置用户名, 密码(此时默认是<code>wsl</code>而不是<code>wsl2</code>)</li>
<li>在<code>powershell</code>中根据文档切换成<code>wsl2</code></li>
<li>若提示切换失败, 可能需要手动安装内核, 去<a href="https://docs.microsoft.com/en-us/windows/wsl/wsl2-kernel" target="_blank" rel="noopener">官网</a>下载安装</li>
</ol>
<h4 id="windows-terminal配置">Windows Terminal配置</h4>
<ol type="1">
<li>主题配置 这里贴一份我自己的配置, 有需要的可以<a href="https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrnfoiwu5i48/b/anan/o/settings.json" target="_blank" rel="noopener">下载</a>修改 <img src="https://pic.rmb.bdstatic.com/3a62a32f090a8aed6fb9caa0af0019eb.png" alt="windows-terminal" /></li>
<li>右键-在此文件夹中打开 这个功能需要添加注册表, 有需要可以<a href="https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrnfoiwu5i48/b/anan/o/right.reg" target="_blank" rel="noopener">下载</a>, 运行</li>
</ol>
<h4 id="wsl2简单配置">wsl2简单配置</h4>
<ol type="1">
<li><p>使用<code>zsh</code>作为默认<code>bash</code>(可选, 这里不做过多介绍)</p></li>
<li><p>当使用<code>Windows Search</code> 打开<code>Windows Terminal</code>时, 默认进入用户目录<code>~</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">&quot;</span> <span class="ot">==</span> *<span class="st">&quot;Windows&quot;</span>*<span class="kw"> ]]</span> ; <span class="kw">then</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="bu">cd</span> ~</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">fi</span></span></code></pre></div>
<blockquote>
<p>由于我使用了oh-my-zsh, 每次安装会覆盖原有的.zshrc, 所以我的所有关于bash配置都写在~/.profile下, 并在.zshrc中使用source .profile加载</p>
</blockquote></li>
<li><p>配置默认使用<code>vim</code>作为可视化编辑器</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="bu">export</span> <span class="va">VISUAL=</span>vim</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="bu">export</span> <span class="va">EDITOR=</span><span class="st">&quot;</span><span class="va">$VISUAL</span><span class="st">&quot;</span></span></code></pre></div></li>
</ol>
<h4 id="wsl2代理设置">wsl2代理设置</h4>
<p><code>wsl2</code>采用的网络模式是<code>Nat</code>模式, 在<code>wsl2</code>中如果想使用<code>Windows</code>下的代理会比较麻烦, 不能直接通过<code>localhost</code>访问</p>
<blockquote>
<p>但Windows却可以使用localhost访问wsl2中的服务, 很便于程序的调试</p>
</blockquote>
<p>首先需要安装<code>proxychains4</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">sudo</span> apt install proxychains4</span></code></pre></div>
<p>复制一份配置文件到用户目录</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">sudo</span> cp /etc/proxychains4.conf ~/.proxychains.conf</span></code></pre></div>
<p>配置bash设置(.profile中)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># 找到windows ip</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="bu">export</span> <span class="va">WIN_IP=</span><span class="kw">`</span><span class="fu">cat</span> /etc/resolv.conf <span class="kw">|</span> <span class="fu">grep</span> nameserver <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $2}&#39;</span><span class="kw">`</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"># 删除原有socks5配置</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="fu">sed</span> -i <span class="st">&#39;/socks5/d&#39;</span> ~/.proxychains.conf</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co"># 添加新的socks5配置</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="fu">sed</span> -i <span class="st">&#39;$a socks5 &#39;</span><span class="va">${WIN_IP}</span><span class="st">&#39; 7891&#39;</span> ~/.proxychains.conf</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="bu">alias</span> pc=<span class="st">&#39;proxychains4 -q -f ~/.proxychains.conf&#39;</span></span></code></pre></div>
<p>这样每次启动都会寻找正确的ip地址, 并设置好给<code>proxychains4</code></p>
<h4 id="vscode设置">vscode设置</h4>
<p>还是由于网络问题, <code>remote server</code>继承了主<code>vscode</code>的配置, 代理会默认被设为<code>127.0.0.1:7890</code>, 会出现无法下载插件, 或无法使用插件等问题</p>
<p>经过测试, 即使在<code>wsl2</code>设置了<code>http_proxy</code>环境变量也没办法生效(主配置已检测到代理), 需要手动设置才能生效 <img src="https://pic.rmb.bdstatic.com/ff4e30a30dd6be1ee200ef58054b83e9.png" alt="vscode-config" /></p>
<h4 id="其他配置">其他配置</h4>
<p>大多数软件都能使用<code>wsl2</code>替代, 如<code>git</code>, <code>c++</code>, <code>python</code>, <code>golang</code>等</p>
<p>但还是有些依赖图形化的软件只能在<code>Windows</code>下运行, 如<code>IDEA</code>, <code>Android Studio</code>等</p>
<p>这些软件也依赖于<code>git</code>, 但又不想在<code>Windows</code>又装一个重量级的<code>git bash</code>, 于是我找到两种解决方案, 一种是<code>git</code>映射到<code>wsl2</code>中的<code>git</code>, 第二种是额外下载一个轻量级的<code>git</code>--<a href="https://github.com/git-for-windows/git/releases" target="_blank" rel="noopener">MinGit</a></p>
<p>这里推荐第二种方法, 简单, 最小只有20M左右, 而且无需安装</p>
<h4 id="坑">坑</h4>
<p><code>wsl2</code>唯一的缺点是无法自动缩进磁盘空间, 当突然下载大文件后又删除后, 虚拟机占用空间并不会减少, 只会持续扩张. 目前解决办法是磁盘分区, 后续官网应该有更好的解决方法</p>
<h4 id="总结">总结</h4>
<p>总得来说, <code>wsl2</code>的体验很不错, 有种在<code>Linux</code>中使用<code>Windows</code>的感觉, 既可以享受<code>Windows</code>众多图形化软件带来的优势, 也可以方便快捷使用<code>Linux</code>做程序开发, 这点就比原生<code>Linux</code>强很多了, 和<code>mac</code>的差距也没那么大了</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/study/assembly-instructions/">上一篇</a><a class="next" href="/tutorial/hexo-theme-dev/">下一篇</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><div id="gitalk-container"></div><script>const gitalk = new Gitalk({
    clientID: '1ad726ece750d0552748',     
    clientSecret: '6917691391883046d263b52a7107fab68e457194',     
    id: window.location.pathname,    
    repo: 'blog',     
    owner: 'achjqz',     
    admin: 'achjqz',     
})   
gitalk.render('gitalk-container')
</script><div class="copyright"><p>© 2020 <a href="http://blog.xhyh.best">xhyh</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/achjqz/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN" crossorigin="anonymous"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/github-gist.min.css"><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script><script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/dockerfile.min.js"></script><script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/x86asm.min.js"></script><script>hljs.initHighlightingOnLoad();</script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117536047-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-117536047-1');</script></body></html>